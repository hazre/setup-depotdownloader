name: Create Release PR

on:
  push:
    branches: [main]

permissions: {}

jobs:
  prepare-release:
    if: "!contains(github.event.head_commit.message, 'chore: prepare release')"
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          persist-credentials: true

      - uses: fregante/setup-git-user@024bc0b8e177d7e77203b48dab6fb45666854b35 # v2.0.2

      - uses: hustcer/setup-nu@920172d92eb04671776f3ba69d605d3b09351c30 # v3
        with:
          version: "0.110.0"

      - uses: knope-dev/action@19617851f9f13ab2f27a05989c55efb18aca3675 # v2.1.2
        with:
          version: 0.22.1

      - name: Collect build info
        id: info
        shell: nu {0}
        run: |
          let sha_short = git rev-parse --short HEAD | str trim
          let version = open package.json | get version
          $"sha_short=($sha_short)\n" | save -a --raw $env.GITHUB_OUTPUT
          $"version=($version)\n" | save -a --raw $env.GITHUB_OUTPUT

      - name: Prepare Release
        id: knope
        shell: nu {0}
        run: |
          let version = $env.VERSION
          let has_tag = (git tag -l "v1.0.0" | str trim) == "v1.0.0"
          let needs_override = $version == "1.0.0" and not $has_tag
          let result = if $needs_override {
            do -i { knope prepare-release --verbose --override-version 1.0.0 } | complete
          } else {
            do -i { knope prepare-release --verbose } | complete
          }
          if $result.exit_code == 0 {
            "released=true\n" | save -a --raw $env.GITHUB_OUTPUT
          } else {
            "released=false\n" | save -a --raw $env.GITHUB_OUTPUT
          }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.info.outputs.version }}
